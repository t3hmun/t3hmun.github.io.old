<!DOCTYPE html>

<html lang="en-GB">

<!-- This is an include file because all pages use the same head.
Liquid Markup is used to customise it for each page. -->
<head>
  <!-- UTF-8 is the best supported modern character-set used almost everywhere. -->
  <meta charset="utf-8">
  <!-- This is needed to suppress Internet Explorer's compatibility mode and make it operate with minimum quirks. -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- This informs small screen devices that the content is intended to wrap inside the screen-width without scaling. 
  This prevents the phone from rendering a miniature parody of the desktop appearance of the site.
  The design of the site must be suitable for this kind of wrapping in a smaller space. -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- A description for search engines and other non-humans. If the page has not description set default to site description. -->
  <meta name="description" content="Clear up the confusing and troublesome nature of encoding and decoding in Python 3, especially when utf-8 and the console is involved.">

  <!-- Title used by the browser and also by search engines and non-humans. -->
  <title>Encoding and Decoding in Python 3</title>

  <!-- The root relative url for the stylesheet. -->
  <link id="maincss" rel="stylesheet" href="http://t3hmun.github.io/css/main.css">
  <!-- The preferred URL for the page. Useful when there are multiple possible urls. -->
  <link rel="canonical" href="http://t3hmun.github.io/article/2015/encoding-and-decoding-in-python-3/">
  <!-- Handy link to the RSS for the site for browsers and non-humans. -->
  <link rel="alternate" type="application/rss+xml" title="t3hmun" href="http://t3hmun.github.io/feed.xml" />
  
  <script src="http://t3hmun.github.io/js/theme.js"></script>
</head>

<body>
  <div class="body-wrapper">

    <header>
      <div class="centre-block" id="top-of-page">
        <div class="art bigart"><a href="http://t3hmun.github.io/">
╭───────────────────╮
│   ╶─╮             │
│ ┼╴ ─┤├─╮╭┬╮╷ ╷┌─╮ │
│ ╰╴╶─╯╵ ╵╵ ╵╰─╯╵ ╵ │
╰───────────────────╯</a></div>
        <nav>
          <div class="art miniart "><a href="http://t3hmun.github.io/about/">         ╷                     
   ╭───╮ ├───╮╭───╮╷   ╷╶┼─╴   
▒  │   │ │   ││   ││   │ │    ▒
   ╰───╰ ╰───╯╰───╯╰───╯ ╰─╴   
</a></div>
          <div class="art miniart"><a href="http://t3hmun.github.io/archive/">                  ╷      .             
   ╭───╮ ╭──╴╭───╴├───╮ ╶┐ ╷  ╷╭───╮   
▒  │   │ │   │    │   │  │ └┐┌┘├───╯  ▒
   ╰───╰ ╵   ╰───╴╵   ╵  ╰╴ └┘ ╰───╯   </a></div>
        </nav>
      </div>
    </header>

    <main>
      <!-- 
The base layout has this wrapped in a main section.
This layout contains a single main article. 
-->
<article>
  <h2><a href="http://t3hmun.github.io/article/2015/encoding-and-decoding-in-python-3/">Encoding and Decoding in Python 3</a></h2>
  <footer>
    <div class="heading-footer">
      <span class="date">
        Posted on:
        <time datetime=" 2015-10-13 15:15 ">2015-10-13 at 15:15</time>
      </span>
      <span class="tags">      
        <a href="http://t3hmun.github.io/archive/#article">[article] - </a>
        <a href="http://t3hmun.github.io/archive/#python">[python] </a>
      </span>
    </div>
  </footer>
  <p>This is an article for people wanting to understand the following error with Python 3:</p>

<div class="other-text-width highlighter-rouge"><pre class="highlight"><code>...
UnicodeEncodeError: 'charmap' codec can't encode character
...
</code></pre>
</div>

<p>Part of an error usually encountered when printing to a console, but possible in many other text situations.</p>

<h3 id="the-problem">The Problem</h3>

<p>Internally Python 3 <strong>always</strong> uses UTF-8 for its strings.
However the source and or destination of a string may have another encoding.</p>

<blockquote>
  <p>Python 2 does not strictly store its strings as utf-8 so one may encounter all sorts of bizarre encoding decoding samples that are only applicable to Python 2. This article only concerns Python 3.</p>
</blockquote>

<p>The most simple example is the print function which automatically re-encodes the string to the console’s encoding.</p>

<div class="reading-width highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">sys</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">encoding</span>
<span class="s">'cp850'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="s">'hello'</span><span class="p">)</span>
<span class="n">hello</span>
<span class="o">&gt;&gt;&gt;</span>
</code></pre>
</div>

<p>In the above example <code class="highlighter-rouge">hello</code> is a utf-8 string, but the <code class="highlighter-rouge">hello</code> printed to the console has been re-encoded to <a href="https://en.wikipedia.org/wiki/Code_page_850">cp850</a>.
This all works fine while the string only uses characters available in cp850.</p>

<p>In the next example an attempt is made to print the mathematical delta increment sign (<code class="highlighter-rouge">∆</code>), which does not exist in cp850:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="s">'</span><span class="se">\u2206</span><span class="s">'</span><span class="p">)</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s">"&lt;stdin&gt;"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
  <span class="n">File</span> <span class="s">"c:</span><span class="err">\</span><span class="s">py34</span><span class="err">\</span><span class="s">python-3.4.2.amd64</span><span class="err">\</span><span class="s">lib</span><span class="err">\</span><span class="s">encodings</span><span class="err">\</span><span class="s">cp850.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">19</span><span class="p">,</span> <span class="ow">in</span> <span class="n">encode</span>
    <span class="k">return</span> <span class="n">codecs</span><span class="o">.</span><span class="n">charmap_encode</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span><span class="n">encoding_map</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">UnicodeEncodeError</span><span class="p">:</span> <span class="s">'charmap'</span> <span class="n">codec</span> <span class="n">can</span><span class="s">'t encode character '</span>\<span class="n">u2206</span><span class="s">' in position 0: character maps to &lt;undefined&gt;</span><span class="err">
</span></code></pre>
</div>

<h3 id="changing-the-console-for-the-text">Changing the Console for the Text</h3>

<p>One solution is to change the console’s code page to Unicode (cp65001) before starting Python, which can be done in the windows command prompt using <code class="highlighter-rouge">chcp</code> (if using GitBash type <code class="highlighter-rouge">chcp.com</code> instead):</p>

<div class="reading-width highlighter-rouge"><pre class="highlight"><code>&gt;chcp 65001
Active code page: 65001
&gt;python
Python 3.4.2 ...
</code></pre>
</div>

<p>After doing so you can work with Unicode to your hearts content:</p>

<div class="reading-width highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">sys</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">encoding</span>
<span class="s">'cp65001'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="s">'</span><span class="se">\u2206</span><span class="s">'</span><span class="p">)</span>
<span class="err">∆</span>
</code></pre>
</div>

<h3 id="changing-the-text-for-the-console">Changing the Text for the Console</h3>

<p>It is not always practical to change to console for the text.
One may want to reliably print whatever the console is capable of printing in the situation.
My solution is a very simple function that replaces characters not compatible with the current console.
Text cleaned in this manner will print without error (but incompatible characters may be replaced with ?).</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'replace'</span><span class="p">):</span>
    <span class="n">encoding</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">encoding</span>
    <span class="k">if</span><span class="p">(</span><span class="n">encoding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s">'utf-8'</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">text</span>
</code></pre>
</div>

<p>This causes the replaced characters to be lost so if you need to accurately pipe of view the Unicode characters this is no good.</p>

<h3 id="starting-to-grok-encode-decode">Starting to Grok Encode Decode</h3>

<p>This is a series of little code samples that should clear up any misconceptions you might have about what the encode and decode functions do.</p>

<h4 id="stringencode">string.encode()</h4>

<p>The <code class="highlighter-rouge">string.encode('encoding')</code> function encodes the string into a <strong>bytes object</strong> of the specified encoding.
It does not create a string, since Python 3 strings are always utf-8 (I stress this point because seeing contradictory Python2 code can result in confusion).</p>

<div class="reading-width highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">sys</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">encoding</span>
<span class="s">'cp850'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">encoded</span> <span class="o">=</span> <span class="s">'hello'</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'cp850'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span>
<span class="n">b</span><span class="s">'hello'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">decoded</span> <span class="o">=</span> <span class="n">encoded</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'cp850'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">decoded</span><span class="p">)</span>
<span class="n">hello</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">type</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span>
<span class="o">&lt;</span><span class="k">class</span> <span class="err">'</span><span class="nc">bytes</span><span class="s">'&gt;</span><span class="err">
</span><span class="s">&gt;&gt;&gt; type(decoded)</span><span class="err">
</span><span class="s">&lt;class '</span><span class="nb">str</span><span class="s">'&gt;</span><span class="err">
</span></code></pre>
</div>

<h4 id="stringdecode">string.decode()</h4>

<p>The <code class="highlighter-rouge">string.decode('encoding')</code> function converts a bytes object representing text into an <strong>utf-8</strong> string.
It always decodes to utf-8 because that what strings are in Python 3.
However the bytes object could be being used to represent any encoding (including utf-8) so that encoding must be specified.</p>

<p>The degrees symbol <code class="highlighter-rouge">º</code> exists in both Unicode and cp850 (everything should exist in Unicode).
The next code example it working in each encoding and the failures that occur when it is decoded with the wrong encoding.
You should be able to reproduce this example fine as long as your console is using one of these 2 encodings.</p>

<blockquote>
  <p><strong>print(byteArray)</strong></p>

  <p>When you ask Python to print a bytes object it will show the corresponding ASCII text to each byte if it is a printable character.
If the corresponding ASCII is non-printable, it is shown as an escaped hex number, for example <code class="highlighter-rouge">\x01</code> is <code class="highlighter-rouge">0x01</code>.
Most encodings are compatible with the printable characters of ASCII so interpreting a byte as the ASCII is a good guess of what is meant by it (but by no means guaranteed).</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="s">'</span><span class="se">\u00ba</span><span class="s">'</span><span class="p">)</span>
<span class="err">º</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">degrees</span> <span class="o">=</span> <span class="s">'</span><span class="se">\u00ba</span><span class="s">'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">degrees</span><span class="p">)</span>
<span class="err">º</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">degreesCp850</span> <span class="o">=</span> <span class="n">degrees</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'cp850'</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">degreesCp850</span><span class="p">)</span>
<span class="n">b</span><span class="s">'</span><span class="se">\xa7</span><span class="s">'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">degreesUtf8</span> <span class="o">=</span> <span class="n">degrees</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">degreesUtf8</span><span class="p">)</span>
<span class="n">b</span><span class="s">'</span><span class="se">\xc2\xba</span><span class="s">'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">degreesCp850</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'cp850'</span><span class="p">))</span>
<span class="err">º</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">degreesCp850</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">))</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s">"&lt;stdin&gt;"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="nb">UnicodeDecodeError</span><span class="p">:</span> <span class="s">'utf-8'</span> <span class="n">codec</span> <span class="n">can</span><span class="s">'t decode byte 0xa7 in position 0: invalid start byte</span><span class="err">
</span><span class="s">&gt;&gt;&gt; print(degreesUtf8.decode('</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span><span class="s">'))</span><span class="err">
</span><span class="s">º</span><span class="err">
</span><span class="s">&gt;&gt;&gt; print(degreesUtf8.decode('</span><span class="n">cp850</span><span class="s">'))</span><span class="err">
</span><span class="s">┬║</span><span class="err">
</span></code></pre>
</div>

<p>The next example uses a string containing only basic printable ASCII compatible characters.
It demonstrates that using incorrect encoding may succeed when using only these basic characters.
Most encodings are purposely designed to act like this, it creates a tolerance for bad encoding on simple text data.</p>

<div class="other-text-width highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">hello</span> <span class="o">=</span> <span class="s">'hello'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">helloCp850</span> <span class="o">=</span> <span class="n">hello</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'cp850'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">helloUtf8</span> <span class="o">=</span> <span class="n">hello</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">helloCp850</span><span class="p">)</span>
<span class="n">b</span><span class="s">'hello'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">helloUtf8</span><span class="p">)</span>
<span class="n">b</span><span class="s">'hello'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">hellpCp850</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'cp-850'</span><span class="p">)</span>
<span class="o">...</span> <span class="p">)</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s">"&lt;stdin&gt;"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="nb">NameError</span><span class="p">:</span> <span class="n">name</span> <span class="s">'hellpCp850'</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">defined</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">helloCp850</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'cp850'</span><span class="p">))</span>
<span class="n">hello</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">helloUtf8</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'cp850'</span><span class="p">))</span>
<span class="n">hello</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">helloUtf8</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">))</span>
<span class="n">hello</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">helloCp850</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">))</span>
<span class="n">hello</span>
</code></pre>
</div>


</article>

    </main>

    <footer>
      <div class="centre-block">
        <div class="bar">
          <div class="art"><a href="#top-of-page">▁▁
scroll ╱╲ to top</a></div>
          <br>
          <br>
        </div>
        <br>
        <div class="art">╭┬╮╭─╮┐│ ▝ 
╵ ╵╰─╵╰╰╴▝ </div><span class="fblock">blog at t3hmun dot com</span>
        <br> See my code at
        <div class="art"><a href="http://github.com/t3hmun"> ╭─╴.   ╷ ╷    
 │ ┐┐ ┼ ├─┤╷╷├╮
 ╰─╯╰╴╰╴╵ ╵╰╯└╯</a></div>
        <br> Site content is licensed as
        <div class="art"><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"> ╭─╴╭─╴ ╭─╮          
 │  │   ├─┤ttribution
 ╰─╴╰─╴ ╵ ╵          </a></div>

        <div class="art"><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"> ╭─╴     ╭─╮    
 ╰─╮hare ├─┤like
 ╶─╯     ╵ ╵    </a></div>

        <div class="centre-block">
          <div class="art bigart"><a href="http://t3hmun.github.io/">
╭───────────────────╮
│   ╶─╮             │
│ ┼╴ ─┤├─╮╭┬╮╷ ╷┌─╮ │
│ ╰╴╶─╯╵ ╵╵ ╵╰─╯╵ ╵ │
╰───────────────────╯</a></div>
        </div>

      </div>
    </footer>


    <div id="theme-changer" class="scripty">
      <a id="lightbutton">light</a> -
      <a id="darkbutton">dark</a> -
      <a href="#top-of-page">top</a>
    </div>

    <div id="toc-toggle-div" class="toc-toggle">
      <a href="" id="toctogglebutton">toc</a>
    </div>


  </div>
</body>

</html>
<!DOCTYPE html>

<html lang="en-GB">

<!-- This is an include file because all pages use the same head.
Liquid Markup is used to customise it for each page. -->
<head>
  <!-- UTF-8 is the best supported modern character-set used almost everywhere. -->
  <meta charset="utf-8">
  <!-- This is needed to suppress Internet Explorer's compatibility mode and make it operate with minimum quirks. -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- This informs small screen devices that the content is intended to wrap inside the screen-width without scaling. 
  This prevents the phone from rendering a miniature parody of the desktop appearance of the site.
  The design of the site must be suitable for this kind of wrapping in a smaller space. -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- A description for search engines and other non-humans. If the page has not description set default to site description. -->
  <meta name="description" content="Clear up the confusing and troublesome nature of encoding and decoding in Python 3, especially when utf-8 and the console is involved.">

  <!-- Title used by the browser and also by search engines and non-humans. -->
  <title>Encoding and Decoding in Python 3</title>

  <!-- The root relative url for the stylesheet. -->
  <link id="maincss" rel="stylesheet" href="http://t3hmun.github.io/css/main.css">
  <!-- The preferred URL for the page. Useful when there are multiple possible urls. -->
  <link rel="canonical" href="http://t3hmun.github.io/article/2015/encoding-and-decoding-in-python-3/">
  <!-- Handy link to the RSS for the site for browsers and non-humans. -->
  <link rel="alternate" type="application/rss+xml" title="t3hmun" href="http://t3hmun.github.io/feed.xml" />
  
  <script src="http://t3hmun.github.io/js/theme.js"></script>
</head>

<body>
  <div class="body-wrapper">

    <header>
      <div class="centre-block" id="top-of-page">
        <div class="art bigart"><a href="http://t3hmun.github.io/">
╭───────────────────╮
│   ╶─╮             │
│ ┼╴ ─┤├─╮╭┬╮╷ ╷┌─╮ │
│ ╰╴╶─╯╵ ╵╵ ╵╰─╯╵ ╵ │
╰───────────────────╯</a></div>
        <nav>
          <div class="art miniart "><a href="http://t3hmun.github.io/about/">         ╷                     
   ╭───╮ ├───╮╭───╮╷   ╷╶┼─╴   
▒  │   │ │   ││   ││   │ │    ▒
   ╰───╰ ╰───╯╰───╯╰───╯ ╰─╴   
</a></div>
          <div class="art miniart"><a href="http://t3hmun.github.io/archive/">                  ╷      .             
   ╭───╮ ╭──╴╭───╴├───╮ ╶┐ ╷  ╷╭───╮   
▒  │   │ │   │    │   │  │ └┐┌┘├───╯  ▒
   ╰───╰ ╵   ╰───╴╵   ╵  ╰╴ └┘ ╰───╯   </a></div>
        </nav>
      </div>
    </header>

    <main>
      <!-- 
The base layout has this wrapped in a main section.
This layout contains a single main article. 
-->
<article>
  <h2><a href="http://t3hmun.github.io/article/2015/encoding-and-decoding-in-python-3/">Encoding and Decoding in Python 3</a></h2>
  <footer>
    <div class="heading-footer">
      <span class="date">
        Posted on:
        <time datetime=" 2015-10-22 13:00 ">2015-10-22 at 13:00</time>
      </span>
      <span class="tags">      
        <a href="http://t3hmun.github.io/archive/#article">[article] - </a>
        <a href="http://t3hmun.github.io/archive/#python">[python] </a>
      </span>
    </div>
  </footer>
  <ul class="toc" id="markdown-toc">
  <li><a href="#what" id="markdown-toc-what">What</a></li>
  <li><a href="#the-problem" id="markdown-toc-the-problem">The Problem</a>    <ul>
      <li><a href="#how-print-works" id="markdown-toc-how-print-works">How <code class="highlighter-rouge">print</code> Works</a></li>
      <li><a href="#simple-error-example-with-print" id="markdown-toc-simple-error-example-with-print">Simple Error Example With <code class="highlighter-rouge">print</code></a></li>
    </ul>
  </li>
  <li><a href="#changing-the-console-for-the-text" id="markdown-toc-changing-the-console-for-the-text">Changing the Console for the Text</a></li>
  <li><a href="#cleaning-the-text-for-the-console" id="markdown-toc-cleaning-the-text-for-the-console">Cleaning the Text for the Console</a></li>
  <li><a href="#lets-grok-encode-decode" id="markdown-toc-lets-grok-encode-decode">Let’s Grok Encode Decode</a>    <ul>
      <li><a href="#stringencode" id="markdown-toc-stringencode">string.encode()</a></li>
      <li><a href="#stringdecode" id="markdown-toc-stringdecode">string.decode()</a></li>
    </ul>
  </li>
  <li><a href="#direct-output-to-stdout" id="markdown-toc-direct-output-to-stdout">Direct Output To <code class="highlighter-rouge">stdout</code></a>    <ul>
      <li><a href="#a-pitfall-of-writing-to-stdoutbuffer" id="markdown-toc-a-pitfall-of-writing-to-stdoutbuffer">A Pitfall of Writing to <code class="highlighter-rouge">stdout.buffer</code></a></li>
    </ul>
  </li>
</ul>

<blockquote>
  <p>Update 2015-26-10: Added information about sys.stdout.buffer.write.</p>
</blockquote>

<h3 id="what">What</h3>

<p>This is an article for people wanting to understand the following error with Python 3:</p>

<div class="other-text-width highlighter-rouge"><pre class="highlight"><code>...
UnicodeEncodeError: 'charmap' codec can't encode character
...
</code></pre>
</div>

<p>Part of an error usually encountered when printing to a console, but possible in many other text situations.
If you are interested in deeply understanding the issue, instead of just copy-pasting SO posts, read on.</p>

<h3 id="the-problem">The Problem</h3>

<p>Internally Python 3 <strong>always</strong> uses UTF-8 for its strings.
However the source and or destination of a string may have another encoding.</p>

<p>Python 2 does not strictly store its strings as utf-8 so one may encounter all sorts of bizarre encoding decoding samples that are only applicable to Python 2. This article only concerns Python 3.</p>

<h4 id="how-print-works">How <code class="highlighter-rouge">print</code> Works</h4>

<p><a href="https://docs.python.org/3/library/functions.html#print">Print is a pretty basic function</a> that tries to convert whatever you give it to a string, adds a newline, and the passes it on to <code class="highlighter-rouge">sys.stdout.write</code>. It has other options, but we’re only interested in its default use at the moment.</p>

<p>The <code class="highlighter-rouge">sys.stdout.write</code> function is <a href="https://docs.python.org/3/library/sys.html#sys.stdout">more interesting</a>:</p>

<blockquote>
  <p>The character encoding is platform-dependent. Under Windows, if the stream is interactive (that is, if its isatty() method returns True), the console codepage is used, otherwise the ANSI code page. Under other platforms, the locale encoding is used (see locale.getpreferredencoding()).</p>
</blockquote>

<p>This means that <code class="highlighter-rouge">sys.stdout.write</code> will re-encode whatever you give it to suit the context.
As a result we are required to give it text that is suitable for re-encoding and if we don’t we get the encoding error that inspired this article.</p>

<h4 id="simple-error-example-with-print">Simple Error Example With <code class="highlighter-rouge">print</code></h4>

<div class="reading-width highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">sys</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">encoding</span>
<span class="s">'cp850'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="s">'hello'</span><span class="p">)</span>
<span class="n">hello</span>
</code></pre>
</div>

<p>In the above example <code class="highlighter-rouge">hello</code> is a utf-8 string, but the <code class="highlighter-rouge">hello</code> printed to the console has been re-encoded to <a href="https://en.wikipedia.org/wiki/Code_page_850">cp850</a>.
This all works fine while the string only uses characters available in cp850.</p>

<p>In the next example an attempt is made to print the mathematical delta increment sign, which does not exist in cp850 (the character appears as a triangle “<code class="highlighter-rouge">∆</code>” the escape in python is <code class="highlighter-rouge">\u2206</code>):</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="s">'</span><span class="se">\u2206</span><span class="s">'</span><span class="p">)</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s">"&lt;stdin&gt;"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
  <span class="n">File</span> <span class="s">"c:</span><span class="err">\</span><span class="s">py34</span><span class="err">\</span><span class="s">python-3.4.2.amd64</span><span class="err">\</span><span class="s">lib</span><span class="err">\</span><span class="s">encodings</span><span class="err">\</span><span class="s">cp850.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">19</span><span class="p">,</span> <span class="ow">in</span> <span class="n">encode</span>
    <span class="k">return</span> <span class="n">codecs</span><span class="o">.</span><span class="n">charmap_encode</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span><span class="n">encoding_map</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">UnicodeEncodeError</span><span class="p">:</span> <span class="s">'charmap'</span> <span class="n">codec</span> <span class="n">can</span><span class="s">'t encode character '</span>\<span class="n">u2206</span><span class="s">' in position 0: character maps to &lt;undefined&gt;</span><span class="err">
</span></code></pre>
</div>

<h3 id="changing-the-console-for-the-text">Changing the Console for the Text</h3>

<p>There are two ways to output utf-8 to the console</p>

<ul>
  <li>Use <code class="highlighter-rouge">print</code> on a utf-8 console</li>
  <li>Use <code class="highlighter-rouge">sys.stdout.buffer.write</code> to write the bytes of utf-8 encoded text.</li>
</ul>

<p>Both of these methods will allow redirection and piping of the utf-8 text, staying in utf-8, however only the text will only appear correctly on the console if the console is set to utf-8.</p>

<p>In the windows command prompt the console’s code page can be changed to Unicode (cp65001) before starting Python using <code class="highlighter-rouge">chcp</code> (if using GitBash type <code class="highlighter-rouge">chcp.com</code> instead):</p>

<div class="reading-width highlighter-rouge"><pre class="highlight"><code>&gt;chcp 65001
Active code page: 65001
&gt;python
Python 3.4.2 ...
</code></pre>
</div>

<p>After doing so you can work with Unicode to your heart’s content:</p>

<div class="reading-width highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">sys</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">encoding</span>
<span class="s">'cp65001'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="s">'</span><span class="se">\u2206</span><span class="s">'</span><span class="p">)</span>
<span class="err">∆</span>
</code></pre>
</div>

<p>Doing same in Linux involves setting UTF-8 as part of your locale.
This is still something I need to play with myself, so I can’t provide more information.</p>

<h3 id="cleaning-the-text-for-the-console">Cleaning the Text for the Console</h3>

<p>It is not always practical to change to console for the text.
One may want to reliably print whatever the console is capable of printing in the situation.
My solution is a very simple function that replaces characters not compatible with the current console.
Text cleaned in this manner will print without error (but incompatible characters will be replaced with <code class="highlighter-rouge">?</code>).</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'replace'</span><span class="p">):</span>
    <span class="n">encoding</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">encoding</span>
    <span class="k">if</span><span class="p">(</span><span class="n">encoding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s">'utf-8'</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">text</span>
</code></pre>
</div>

<p>This causes the original value of the replaced characters to be lost, so if you need to accurately pipe, redirect or view the incompatible utf-8 characters, this is no good.
Also this is inefficient, since the text will be encoded again. You could simply skip the decode and pass the bytes to <code class="highlighter-rouge">sys.stdout.buffer.write</code> instead of using <code class="highlighter-rouge">print</code> (more on this later).</p>

<h3 id="lets-grok-encode-decode">Let’s Grok Encode Decode</h3>

<p>This is a series of little code samples that should clear up any misconceptions you might have about what the encode and decode functions do.</p>

<h4 id="stringencode">string.encode()</h4>

<p>The <code class="highlighter-rouge">string.encode('encoding')</code> function encodes the string into a <strong>bytes object</strong> of the specified encoding.
It does not create a string, since Python 3 strings are always utf-8 (I stress this point because seeing contradictory Python2 code can result in confusion).</p>

<div class="reading-width highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">sys</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">encoding</span>
<span class="s">'cp850'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">encoded</span> <span class="o">=</span> <span class="s">'hello'</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'cp850'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span>
<span class="n">b</span><span class="s">'hello'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">decoded</span> <span class="o">=</span> <span class="n">encoded</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'cp850'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">decoded</span><span class="p">)</span>
<span class="n">hello</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">type</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span>
<span class="o">&lt;</span><span class="k">class</span> <span class="err">'</span><span class="nc">bytes</span><span class="s">'&gt;</span><span class="err">
</span><span class="s">&gt;&gt;&gt; type(decoded)</span><span class="err">
</span><span class="s">&lt;class '</span><span class="nb">str</span><span class="s">'&gt;</span><span class="err">
</span></code></pre>
</div>

<h4 id="stringdecode">string.decode()</h4>

<p>The <code class="highlighter-rouge">string.decode('encoding')</code> function converts a bytes object representing text into an <strong>utf-8</strong> string.
It always decodes to utf-8 because that what strings are in Python 3.
However the bytes object could be being used to represent any encoding (including utf-8) so that encoding must be specified.</p>

<p>The degrees symbol <code class="highlighter-rouge">º</code> exists in both Unicode and cp850 (everything should exist in Unicode).
The next code example it working in each encoding and the failures that occur when it is decoded with the wrong encoding.
You should be able to reproduce this example fine as long as your console is using one of these 2 encodings.</p>

<blockquote>
  <p><strong>print(bytes)</strong></p>

  <p>When you ask Python to print a bytes object it will show the corresponding ASCII text to each byte if it is a printable character.
If the corresponding ASCII is non-printable or the value is non-ASCII (above 127), it is shown as an escaped hex number, for example ASCII <code class="highlighter-rouge">0x01</code> (SOH) is escaped as<code class="highlighter-rouge">\x01</code>.
Most encodings are compatible with the printable characters of ASCII so interpreting a byte as the ASCII is a good guess of what is meant by it (but by no means guaranteed).</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="s">'</span><span class="se">\u00ba</span><span class="s">'</span><span class="p">)</span>
<span class="err">º</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">degrees</span> <span class="o">=</span> <span class="s">'</span><span class="se">\u00ba</span><span class="s">'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">degrees</span><span class="p">)</span>
<span class="err">º</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">degreesCp850</span> <span class="o">=</span> <span class="n">degrees</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'cp850'</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">degreesCp850</span><span class="p">)</span>
<span class="n">b</span><span class="s">'</span><span class="se">\xa7</span><span class="s">'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">degreesUtf8</span> <span class="o">=</span> <span class="n">degrees</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">degreesUtf8</span><span class="p">)</span>
<span class="n">b</span><span class="s">'</span><span class="se">\xc2\xba</span><span class="s">'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">degreesCp850</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'cp850'</span><span class="p">))</span>
<span class="err">º</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">degreesCp850</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">))</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s">"&lt;stdin&gt;"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="nb">UnicodeDecodeError</span><span class="p">:</span> <span class="s">'utf-8'</span> <span class="n">codec</span> <span class="n">can</span><span class="s">'t decode byte 0xa7 in position 0: invalid start byte</span><span class="err">
</span><span class="s">&gt;&gt;&gt; print(degreesUtf8.decode('</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span><span class="s">'))</span><span class="err">
</span><span class="s">º</span><span class="err">
</span><span class="s">&gt;&gt;&gt; print(degreesUtf8.decode('</span><span class="n">cp850</span><span class="s">'))</span><span class="err">
</span><span class="s">┬║</span><span class="err">
</span></code></pre>
</div>

<p>The next example uses a string containing only basic printable ASCII compatible characters.
It demonstrates that using incorrect encoding may succeed when using only these basic characters.
Most encodings are purposely designed to act like this, it creates a tolerance for bad encoding on simple text data.</p>

<div class="other-text-width highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">hello</span> <span class="o">=</span> <span class="s">'hello'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">helloCp850</span> <span class="o">=</span> <span class="n">hello</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'cp850'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">helloUtf8</span> <span class="o">=</span> <span class="n">hello</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">helloCp850</span><span class="p">)</span>
<span class="n">b</span><span class="s">'hello'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">helloUtf8</span><span class="p">)</span>
<span class="n">b</span><span class="s">'hello'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">hellpCp850</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'cp-850'</span><span class="p">)</span>
<span class="o">...</span> <span class="p">)</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s">"&lt;stdin&gt;"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="nb">NameError</span><span class="p">:</span> <span class="n">name</span> <span class="s">'hellpCp850'</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">defined</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">helloCp850</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'cp850'</span><span class="p">))</span>
<span class="n">hello</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">helloUtf8</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'cp850'</span><span class="p">))</span>
<span class="n">hello</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">helloUtf8</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">))</span>
<span class="n">hello</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">helloCp850</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">))</span>
<span class="n">hello</span>
</code></pre>
</div>

<h3 id="direct-output-to-stdout">Direct Output To <code class="highlighter-rouge">stdout</code></h3>

<p>The final method of working with utf-8 or any specified encoding is to send raw bytes directly to <code class="highlighter-rouge">stdout</code> skipping the automatic encoding. This is the only way to guarantee that your encoding is kept intact, useful when the intent is to have utf-8 (or anything else) output piped or redirected to other places intact.</p>

<p>As mentioned before <code class="highlighter-rouge">sys.stdout.write(string)</code> encodes by default, however using <code class="highlighter-rouge">sys.stdout.buffer.write(bytes)</code> skips the automatic encoding allowing you to output whatever you want intact.</p>

<p>The following simple Python script:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sys</span>

<span class="k">print</span><span class="p">(</span><span class="s">'1 sys.stdout.encoding: '</span> <span class="o">+</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>

<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="nb">buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'2 hello</span><span class="se">\n</span><span class="s">'</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="nb">buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'3 delta triangle: </span><span class="se">\u2206\n</span><span class="s">'</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="nb">buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'4 GPB currency symbol: £</span><span class="se">\n</span><span class="s">'</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="nb">buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'5 delta triangle: </span><span class="se">\u2206\n</span><span class="s">'</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'cp850'</span><span class="p">,</span> <span class="s">'replace'</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="nb">buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'6 GPB currency symbol: £</span><span class="se">\n</span><span class="s">'</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'cp850'</span><span class="p">))</span>
</code></pre>
</div>

<p>Has the output:</p>

<div class="reading-width highlighter-rouge"><pre class="highlight"><code>1 sys.stdout.encoding: cp850
2 hello
3 delta triangle: Ôêå
4 GPB currency symbol: ┬ú
5 delta triangle: ?
6 GPB currency symbol: £
</code></pre>
</div>

<p>Encode defaults to utf-8, so so <code class="highlighter-rouge">.encode()</code> is outputting utf-8 encoded text.
This works fine for pure ASCII characters (<code class="highlighter-rouge">hello</code>) that are encoding-compatible with most code-pages but outputs garbage when it encounters anything beyond basic ASCII, as seen on output lines 3 and 4.</p>

<p>The delta triangle is not compatible with cp850 so it is output as a <code class="highlighter-rouge">?</code> even when encoded properly.
Note that if the <code class="highlighter-rouge">'replace'</code> option was not specified, it would have defaulted to <code class="highlighter-rouge">'strict'</code> mode and crashed with the error that inspired this article.</p>

<p>Notably the British pound symbol <code class="highlighter-rouge">£</code> can be displayed in cp850 <code class="highlighter-rouge">print('£')</code>, however the encoding for this symbol is different so it only works when the correct encoding is specified.</p>

<h4 id="a-pitfall-of-writing-to-stdoutbuffer">A Pitfall of Writing to <code class="highlighter-rouge">stdout.buffer</code></h4>

<p>Now lets have a look at what happens when we redirect the output of the previous example to a text file (<code class="highlighter-rouge">example.py &gt; x.txt</code>):</p>

<div class="reading-width highlighter-rouge"><pre class="highlight"><code>2 hello
3 delta triangle: âˆ†
4 GPB currency symbol: Â£
5 delta triangle: ?
6 GPB currency symbol: œ
1 sys.stdout.encoding: cp1252
</code></pre>
</div>

<p>The output is in the wrong order, the text output with <code class="highlighter-rouge">print</code> appears last.
<code class="highlighter-rouge">print</code> uses <code class="highlighter-rouge">sys.stdout.buffer</code> (by default) and this buffers the text before output.
Since Python 3.3 <code class="highlighter-rouge">print</code> now has a flush argument that will prevent this disordering of output.
Otherwise you can use <code class="highlighter-rouge">sys.stdout.flush()</code> after the print for the same effect.</p>

<p>After doing a search I have found that people seem to be confused about what is buffered by python when and what is buffered by the console and when these bufferings come into effect.</p>

<p>The <a href="https://docs.python.org/3/library/sys.html#sys.stdout">Python documentation on this</a> is a bit thin for my liking:</p>

<blockquote>
  <p>When interactive, standard streams are line-buffered. Otherwise, they are block-buffered like regular text files. You can override this value with the <code class="highlighter-rouge">-u</code> command-line option.</p>

  <blockquote>
    <p><strong>Note</strong></p>

    <p>To write or read binary data from/to the standard streams, use the underlying binary buffer object. For example, to write bytes to stdout, use <code class="highlighter-rouge">sys.stdout.buffer.write(b'abc')</code>.</p>

    <p>However, if you are writing a library (and do not control in which context its code will be executed), be aware that the standard streams may be replaced with file-like objects like <code class="highlighter-rouge">io.StringIO</code> which do not support the buffer attribute.</p>
  </blockquote>
</blockquote>

<p>Now I’m lost. I intend to figure this out and update this article accordingly soon.</p>



  <section>
    <div id="comments-load-button" class="comments-load-button">
        <script type="text/javascript">
        function loadcomments() {

            //Hide the load button, it is no longer needed.
            document.getElementById('comments-load-button').style.display = 'none'

            //Unhide the comments div.
            document.getElementById('disqus_thread').style.display = 'block'

            //Page-specific configuration for Disqus comments.
            var disqus_config = function() {
                //Base url is a mess when testing and i might sqitch domain anyway.
                //this.page.url = http://t3hmun.github.io/article/2015/encoding-and-decoding-in-python-3/;
                this.page.identifier = "2015-10-22 13:00:00 +0100-Encoding and Decoding in Python 3";
            };


            //Create an element for the script and then shove it in the head.
            var scriptele = document.createElement('script')
            scriptele.setAttribute("type", "text/javascript")
            scriptele.setAttribute("src", "http://t3hmun.github.io/js/disqus.js")
            document.getElementsByTagName("head")[0].appendChild(scriptele)
        }
        </script>
        <div class="centre-block">
            Loading comments will open connections to <a href="https://help.disqus.com/customer/portal/topics/215159-terms-and-policies/articles">Disqus</a> and <a href="https://support.google.com/analytics/answer/6004245?hl=en">Google</a>.
            <br>
            <a href="http://t3hmun.github.io/images/nudgenudge.png">It may be possible</a> that they will datamine and track you and your comments.
            <br>
            <br>
            <button onclick="loadcomments()">Click to load Disqus comments</button>
        </div>
    </div>
    <div id="disqus_thread" class="comments-block"></div>
</section>


</article>

    </main>

    <footer>
      <div class="centre-block">
        <div class="bar">
          <div class="art"><a href="#top-of-page">▁▁
scroll ╱╲ to top</a></div>
          <br>
          <br>
        </div>
        <br>
        <div class="art">╭┬╮╭─╮┐│ ▝ 
╵ ╵╰─╵╰╰╴▝ </div><span class="fblock">blog at t3hmun dot com</span>
        <br> See my code at
        <div class="art"><a href="http://github.com/t3hmun"> ╭─╴.   ╷ ╷    
 │ ┐┐ ┼ ├─┤╷╷├╮
 ╰─╯╰╴╰╴╵ ╵╰╯└╯</a></div>
        <br> Site content is licensed as
        <div class="art"><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"> ╭─╴╭─╴ ╭─╮          
 │  │   ├─┤ttribution
 ╰─╴╰─╴ ╵ ╵          </a></div>

        <div class="art"><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"> ╭─╴     ╭─╮    
 ╰─╮hare ├─┤like
 ╶─╯     ╵ ╵    </a></div>

        <div class="centre-block">
          <div class="art bigart"><a href="http://t3hmun.github.io/">
╭───────────────────╮
│   ╶─╮             │
│ ┼╴ ─┤├─╮╭┬╮╷ ╷┌─╮ │
│ ╰╴╶─╯╵ ╵╵ ╵╰─╯╵ ╵ │
╰───────────────────╯</a></div>
        </div>

      </div>
    </footer>


    <div id="theme-changer" class="scripty">
      <a id="lightbutton">light</a> -
      <a id="darkbutton">dark</a> -
      <a href="#top-of-page">top</a>
    </div>

    <div id="toc-toggle-div" class="toc-toggle">
      <a href="" id="toctogglebutton">toc</a>
    </div>

  </div>
</body>

</html>